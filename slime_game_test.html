<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Slime.io</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>

	<!--Healthbar library -->
	<script type="text/javascript" src="js/HealthBar.js"></script>

	<!--2D-Collision library -->
	<script type="text/javascript" src="js/SAT.js"></script>
    
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update});

function preload() {
	game.load.image('sky','assets/sky.png');
	game.load.spritesheet('dude','assets/dude.png',32,48);
	game.load.spritesheet('red-slime','assets/slime_test.png',26,26,4);
}

var player;
var ball;

function create() {
	//enable ARCADE physics
	game.physics.startSystem(Phaser.Physics.ARCADE);
	
	//Add a simple background
	game.add.sprite(0,0,'sky');


	//create player
	player = game.add.sprite(32,game.world.height - 150,'red-slime');
	player.scale.setTo(2,2);

	//create npc
	bot = game.add.sprite(150,150, 'red-slime');
	bot.scale.setTo(2,2);
	
	game.physics.arcade.enable(player);

	//physics properties
	player.body.collideWorldBounds = true;
	player.body.max_acceleration = 20000;
	
	player.body.dir = {}; //create the dir property
	player.body.dir.x = 0;
	player.body.dir.y = 0;

	player.energybar = new HealthBar(this.game, {x: player.body.center.x, y: player.body.center.y + 30, width: 40, height: 5, animationDuration: 10});
    
	//Animations 
    player.animations.add('left', [0], 10, true);
    player.animations.add('down', [1],10,true);
    player.animations.add('right', [2], 10, true);
    player.animations.add('up', [3], 10, true);

	cursors = game.input.keyboard.createCursorKeys();
	game.input.mousePointer.leftButton.onUp.add(onrelease,this);
}

function render(){	
	game.debug.text("Held Duration: " + game.input.mousePointer.leftButton.duration, 300, 132);
	game.debug.text("Vel x: " + player.body.velocity.x, 300, 152);
	game.debug.text("Vel y: " + player.body.velocity.y, 300, 172);

	//game.debug.body(player);
}

var applied_accel_x = 0;
var applied_accel_y = 0;
var friction_x=0;
var friction_y=0;
var last_angle = 0;

function onrelease(pointer){

	//reference to mousePointer Object
	var p = game.input.mousePointer; 

	//angle between player object and the mouse, used to find direction
	var angle = game.math.angleBetween(player.body.center.x, player.body.center.y,p.x,p.y);

	last_angle = angle; //remember the direction of travel

	//duration of pointer held
	var dur = pointer.timeUp - pointer.timeDown;
	var accel = dur*50;
	if (accel < player.body.max_acceleration)
		{
			applied_accel_x = accel*Math.cos(angle);
			applied_accel_y = accel*Math.sin(angle);
		}
		else{
			applied_accel_x = player.body.max_acceleration*Math.cos(angle);
			applied_accel_y = player.body.max_acceleration*Math.sin(angle);
		}
}


function update() {

	player.energybar.setPosition(player.body.center.x, player.body.center.y + 30);

	//if button is held down
	if (game.input.mousePointer.leftButton.isDown){
		var dur = game.input.mousePointer.leftButton.duration;
		var accel = dur*50;

		var percentage = accel/player.body.max_acceleration * 100;
		player.energybar.setPercent(percentage);

	}else{
		player.energybar.setPercent(0);
	}

	//Collision mechanics

	//acceleration is made up of 3 components, directions, applied acceleration, friction
	
	if (player.body.velocity.x >= 0) {
		player.body.dir.x = 1;
	} else{
		player.body.dir.x = -1;
	}

	if (player.body.velocity.y >= 0) {
		player.body.dir.y = 1;
	} else{
		player.body.dir.y = -1;
	}	

	//game.debug.text("dir_x: " + dir_x, 300, 200);

	if (Math.abs(player.body.velocity.x) < 5 ){
		friction_x = 0;
		player.body.velocity.x = 0;
	}
	else{
		friction_x = -200*Math.abs(Math.cos(last_angle)); //constant friction
	}

	if (Math.abs(player.body.velocity.y) < 5 ){
		friction_y = 0;
		player.body.velocity.y = 0;
	}
	else{
		friction_y = -200*Math.abs(Math.sin(last_angle)); //constant friction
	}	

	player.body.acceleration.x = player.body.dir.x*(friction_x) + applied_accel_x;
	
	if (Math.abs(applied_accel_x) < 1){
		applied_accel_x = 0;
	}
	else{
		applied_accel_x = applied_accel_x*0.5; //decays
	}

	player.body.acceleration.y = player.body.dir.y*(friction_y )+ applied_accel_y;
	
	if (Math.abs(applied_accel_y) < 1){
		applied_accel_y = 0;
	}
	else{
		applied_accel_y = applied_accel_y*0.5; //decays
	}


	//if direction of travel is between -45 to 45 degree ie -pi/4 to pi/4
	if (last_angle > -Math.PI/4 && last_angle < Math.PI/4){
		player.animations.play('right');
	}
	else if (last_angle > Math.PI/4 && last_angle < Math.PI*3/4 ){
		player.animations.play('down');
	}
	else if ((last_angle > Math.PI*3/4 && last_angle < Math.PI) || (last_angle < -Math.PI*3/4 && last_angle > -Math.PI) ){
		player.animations.play('left');
	}
	else if (last_angle < -Math.PI/4 && last_angle > -Math.PI*3/4 ){
		player.animations.play('up');
	}


	render();
}

</script>

</body>
</html>